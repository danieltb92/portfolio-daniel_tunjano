---
import Layout from "@/layouts/Layout.astro";
import projectsData from "@/data/projects.json";
import type { GetStaticPaths } from "astro";
import Button from "@/components/ui/Button.astro";
import fs from "node:fs/promises";
import path from "node:path";
import { marked } from "marked";
import ArrowLeft from "@/assets/icons/arrow-narrow-left.svg";

// Configurar marked para permitir HTML
const renderer = new marked.Renderer();
marked.setOptions({
  renderer: renderer,
  gfm: true,
  breaks: true,
  pedantic: false,
  silent: false,
  hooks: undefined,
});

export const getStaticPaths = (async () => {
  const project = await Promise.all(
    projectsData.map(async (project) => {
      // Leer el archivo markdown correspondiente
      const mdPath = path.join(
        process.cwd(),
        "src/content/project",
        `${project.slug}.md`,
      );
      let content = "";

      try {
        const mdContent = await fs.readFile(mdPath, "utf-8");
        // Eliminar el frontmatter
        const contentWithoutFrontmatter = mdContent.replace(
          /^---\n.*?\n---\n/s,
          "",
        );
        content = await marked.parse(contentWithoutFrontmatter); // Convertir MD a HTML
      } catch (error) {
        console.error(`Error leyendo markdown para ${project.slug}:`, error);
      }

      return {
        params: { slug: project.slug },
        props: { project, content },
      };
    }),
  );

  return project;
}) satisfies GetStaticPaths;

const { project, content } = Astro.props;
---

<Layout
  title={project.title}
  description={typeof project.description === "string"
    ? project.description
    : undefined}
>
  <main class="max-w-3xl mx-auto px-4 py-12 md:py-20">
    <!-- Header -->
    <header class="mb-10">
      <Button
        variant="ghost"
        size="md"
        href="/#projects"
        class="mb-8 mt-6 md:mt-8 ml-0 pl-0"
        ariaLabel="Back to projects"
      >
        <ArrowLeft />
      </Button>

      <h1
        class="text-4xl md:text-5xl font-bold mb-1 text-[--color-text] tracking-tight text-balance"
        style="view-transition-name: project-title;"
      >
        {project.title}
      </h1>

      <div class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-3">
        By Daniel Tunjano
      </div>

      <div
        class="flex flex-wrap items-center gap-4 text-gray-500 dark:text-gray-400 text-sm font-medium"
      >
        {
          project.created_date && (
            <time datetime={project.created_date}>
              {new Date(project.created_date).toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
              })}
            </time>
          )
        }

        {
          project.url && (
            <>
              <span class="text-gray-300 dark:text-gray-600">â€¢</span>
              <a
                href={project.url}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-1.5 text-[var(--primary-blue-500)] hover:text-[var(--primary-blue-400)] dark:text-[var(--primary-blue-400)] dark:hover:text-[var(--primary-blue-300)] transition-colors"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
                </svg>
                <span>Visit Website</span>
              </a>
            </>
          )
        }
      </div>

      {
        project.type && (
          <div class="mt-4">
            <span class="inline-block px-4 py-1 bg-blue-600 dark:bg-blue-500 text-white rounded-full text-sm font-medium">
              {project.type}
            </span>
          </div>
        )
      }

      {
        project.tags && project.tags.length > 0 && (
          <div class="flex flex-wrap gap-2 mt-4">
            {project.tags.map((tag: string) => (
              <span class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-full text-xs font-medium">
                {tag}
              </span>
            ))}
          </div>
        )
      }

      <hr class="mt-8 border-[var(--color-text)]" />
    </header>

    <!-- Content -->
    <article
      class="prose dark:prose-invert max-w-none
        prose-headings:font-bold prose-headings:text-gray-900 dark:prose-headings:text-white
        prose-p:text-gray-600 dark:prose-p:text-gray-300 prose-p:leading-relaxed
        prose-a:text-blue-600 dark:prose-a:text-blue-400 prose-a:no-underline hover:prose-a:underline
        prose-img:rounded-xl prose-img:shadow-lg prose-img:w-full prose-img:my-8
        prose-video:w-full prose-video:rounded-xl prose-video:my-8
        prose-iframe:w-full prose-iframe:rounded-xl prose-iframe:my-8"
      set:html={content}
    />
  </main>
</Layout>

<style>
  @reference "../../styles/global.css";
  /* Estilos adicionales para el contenido */
  :global(.prose blockquote) {
    @apply p-4 border-0 border-blue-600 bg-blue-50 text-gray-700 italic my-8;
  }
  :global(.prose video),
  :global(.prose iframe) {
    @apply my-8;
  }

  :global(.prose pre) {
    @apply p-4 rounded-lg bg-gray-800 text-white overflow-x-auto;
  }

  :global(.prose code) {
    @apply text-sm;
  }

  :global(.prose img) {
    @apply my-8;
  }

  /* Ajustes para columnas de Notion */
  :global(.notion-column img) {
    @apply my-0;
  }

  :global(.notion-column p) {
    @apply my-0;
  }

  /* Notion Divider Styles */
  :global(.prose hr) {
    @apply my-12 border-gray-200 dark:border-gray-800 border-t-2;
  }
</style>
