---
// src/components/layout/Head.astro
import SEO from "@/components/seo/SEO.astro";
import seo from "@/data/seo.json";

const { pathname } = Astro.url;
// Buscar coincidencia exacta o por patrón (soporta comodines tipo /projects/*)
function matchSEO(
  pages: Array<{ path: string; title: string; description: string }>,
  path: string
): { path: string; title: string; description: string } | undefined {
  if (!Array.isArray(pages)) return undefined;
  // Coincidencia exacta primero
  let found = pages.find((p) => p.path === path);
  if (found) return found;
  // Coincidencia por wildcard
  found = pages.find(
    (p) => p.path.endsWith("/*") && path.startsWith(p.path.replace("/*", ""))
  );
  return found;
}

const matchedSEO = matchSEO(seo.pages, pathname);
// Permitir sobreescribir desde props (útil para páginas dinámicas)
const props = Astro.props || {};
function isValid(val: unknown): val is string {
  return typeof val === "string" && val.trim().length > 0;
}
const pageSEO = {
  title: isValid(props.title)
    ? props.title
    : matchedSEO && isValid(matchedSEO.title)
      ? matchedSEO.title
      : seo.default.title,
  description: isValid(props.description)
    ? props.description
    : matchedSEO && isValid(matchedSEO.description)
      ? matchedSEO.description
      : seo.default.description,
};
const currentLang = Astro.currentLocale || "es";
---

<head>
  <link rel="sitemap" href="/sitemap-index.xml" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <script src="https://t.contentsquare.net/uxa/d5eecf66467a1.js"></script>
  <link
    rel="preload"
    href="/fonts/Kufam-VariableFont_wght.ttf"
    as="font"
    type="font/ttf"
    crossorigin
  />
  <SEO
    title={pageSEO.title}
    description={pageSEO.description}
    keywords={seo.default.keywords}
    author={seo.default.author}
    image={seo.default.image}
    siteName={seo.default.siteName}
    locale={seo.default.locale}
    type={seo.default.type}
    robots="index, follow"
  />

  <!-- PREVENT FLASH + MANEJO REAL DEL THEME -->
  <script>
    (function () {
      const saved = localStorage.getItem("theme");
      const prefersDark = window.matchMedia(
        "(prefers-color-scheme: dark)"
      ).matches;

      let theme = "light";
      if (saved === "dark") {
        theme = "dark";
      } else if (saved === "light") {
        theme = "light";
      } else {
        // system or undefined
        theme = prefersDark ? "dark" : "light";
      }

      document.documentElement.setAttribute("data-theme", theme);
      if (theme === "dark") {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
    })();
  </script>
</head>
